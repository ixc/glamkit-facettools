================
GLAMkit-facettools
================

A tool for dealing with facets in collections. It is part of the `GLAMkit project <http://glamkit.org/>`_. For more information, see the `documentation <http://docs.glamkit.org/stopspam/>`_.

View a full list of `GLAMkit components <http://docs.glamkit.org/components/>`_.

approach
==========

Facets present ways of narrowing down an item selection, by showing what the options are, and how many results will be produced.

This module does most of the legwork in setting up facets for Django models.

The emphasis is on flexibility and ease of use. There is not much speed optimisation as yet (so cache heavily!)

Refer to tests.py for more examples of behaviour.

Overview
--------
A facet item contains the information necessary to render a single facet option, as part of a list or drop-down.

FacetItems are generated by FacetFactories, of which there are a few different types provided. For more complex facets, you can define your own FacetFactories.

Setting up a simple facet
-------------------------
Let's say you have an Event model that allows the number of acts to be recorded:

    class Event(models.Model):
        title = models.CharField(max_length=100)
        num_acts = models.IntegerField()

To facet on the number of acts, you create an ActsFacet:

    class NumberFacet(FacetFactory):
        pool = Event.objects.all()
        GET_key = "acts"
        model_field = "num_acts"

Where:
        
    `pool` is the queryset of django objects that the facet operates on. You might want to change this to all 'published' items.

    `GET_key` is the key of the request's GET dictionary that this facet affects.

    `model_field` is the field of the pool to facet on.
    
To facet all events by the number of acts, you simply call:

    NumberFacet().get_facets()

Which generates all the FacetItems, starting with "All" items.

Each FacetItem has a `render` method which renders an html link.

    >>> facets = NumberFacet().get_facets()
    >>> facets.next().render()
    <a href="?acts=3">3 <span class="count">(42)</span></a>

Combining Facets
----------------
Calling get_facets() on its own stops being useful if you've chosen other facets elsewhere. Each facet needs to be aware of the other facets that have been chosen.

Each facet also needs to generate links that don't turn off the other facets.

Each facet also needs an "All" item that turns the facet off, it was previously chosen.

To accomplish all of these things, you need to start passing `request` around.

    >>> facets = NumberFacet().get_facets(request=r) # assume a request `r` that has a GET param attached that selects a 'free' facet elsewhere.
    >>> facets.next().render()
    <a href="?acts=3&free=y">3 <span class="count">(22)</span></a>

Applying Facets
---------------
All of the facets can be applied for a given request, like this:

qs = FacetFactory.apply_filter(pool=Event.objects.all(), request=get_request)

qs now contains the Event objects that match the facets specified in the request.

The FacetFactory class has a registry of all the Facets that exist, and applies any that match the GET query.

Facets on ForeignKeys
---------------------
    class Venue(models.Model):
        title = models.CharField(max_length=100)
        slug = models.SlugField(max_length=100)

    class Event(models.Model):
        title = models.CharField(max_length=100)
        venue = models.ForeignKeyField(Venue)

can be faceted on Venue like this:

class VenueFacet(FacetFactory):
    pool = Event.objects.all()
    GET_key = 'venue'
    model_field = 'venue__slug'
    model_field_for_label = 'venue__title'
    # optionally
    model_field_for_ordering = 'venue__title'


FacetFactory Variations
-----------------------
There are a few variations defined in facetfactories.py. They all override one or more methods of FacetFactory.

* SlugFacetFactory produces lowercase GET values, and does an iexact comparison for facet matching.

* BooleanFacetFactory produces "yes" and "no" labels and "y" and "n" GET values, instead of True and False.

* M2MFacetFactory takes an extra parameter, `m2m_field`, that indicates a ManyToManyField to use for the facets instead. model_field and model_field_for_label act on the related model, not the Facet's pool.

The future
----------
At the moment, there can only be one set of facets per site. In the future we will introduce a facet registry. Each registry will contain the pool and the relevant facets to apply.